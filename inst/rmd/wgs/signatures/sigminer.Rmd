---
author: "University of Melbourne Centre for Cancer Research"
date: "`r format(Sys.time(), '%a %Y-%b-%d %H:%M')`"
output:
  html_document:
    code: hide
    theme: cosmo
    toc: true
    code_download: true
  rmdformats::material:
    highlight: kate
params:
  sample: "SAMPLE"
  snv_vcf: "/path/to/snv.vcf"
  sv_vcf: "/path/to/sv.vcf"
  cnv_tsv: "/path/to/purple.somatic.cnv"
  snvoutdir: "/path/to/outdir_snv"
title: "`r glue::glue('Results from sigminer')`"
description: "sigminer Results"
---

<style type="text/css">
.main-container {
  max-width: 1400px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r render_report_interactively, eval=F, echo=F}
params <- function(x) {
  paths <- list(
    local = list(
      sample = "SAMPLE",
      snv_vcf = here::here("inst/extdata/umccrise/v0.18/snv/somatic-ensemble-PASS.vcf.gz"),
      sv_vcf = here::here("inst/extdata/umccrise/v0.18/sv/manta.vcf.gz"),
      cnv_tsv = here::here("inst/extdata/purple/v2.39/purple.cnv.somatic.tsv"),
      maf = here::here("inst/extdata/umccrise/v0.18/maf/somatic-PASS.maf"),
      outdir = here::here("nogit/sigminer")
      
    )
  )
    paths[[x]]
}
params <- params("local")

render_me <- function() {
  rmarkdown::render(
    input = here::here("inst/rmd/wgs/signatures/sigminer.Rmd"),
    params = params)
}
render_me()
```

```{r load_pkgs, message=F, warning=F}
require(Biostrings)
require(BSgenome.Hsapiens.UCSC.hg19)
require(BSgenome.Hsapiens.UCSC.hg38)
require(DT)
require(gpgr)
require(gt)
require(here)
require(maftools)
require(NMF)
require(sigminer)
require(tidyverse)
```

## Introduction

Here we are using
[sigminer](https://github.com/ShixiangWang/sigminer) to determine somatic
signatures.

## COSMIC Signature Identification

### Read MAF files

We can read in MAF files from multiple samples using `maftools::merge_mafs`.

```{r read_maf}
laml <- system.file("extdata/tcga_laml.maf.gz", package = "maftools") %>% sigminer::read_maf()
# apgi <- list.files(here::here("nogit/inputs/maf"), pattern = "maf$", full.names = T) %>% maftools::merge_mafs()
# saveRDS(apgi, file = here::here("nogit/inputs/maf/all_merged.rds"))
apgi <- readRDS(file = here::here("nogit/inputs/maf/all_merged.rds"))
```

### Tally components

#### SBS

* Divide SBS mutations into 96 mutation types (C>A, C>G, C>T, T>A, T>C, T>G
  times 4 at 5' times 4 at 3'). Returns list with `SBS_6`, `SBS_96` and `SBS_1536`.
  `nmf_matrix` is same as `SBS_96`
* The `add_trans_bias` option will add the `SBS_24`, `SBS_384` and `SBS_6144` matrices.

```{r calc_sbs}
laml_SBS <- sigminer::sig_tally(
  laml,
  ref_genome = "BSgenome.Hsapiens.UCSC.hg19",
  useSyn = TRUE
)

apgi_SBS <- sigminer::sig_tally(
  apgi,
  ref_genome = "BSgenome.Hsapiens.UCSC.hg38",
  useSyn = TRUE
)

str(apgi_SBS, list.len = 3)
stopifnot(identical(apgi_SBS$nmf_matrix, apgi_SBS$all_matrices$SBS_96))
```


#### DBS and ID

* Use `mode = "DBS"` or `mode = "ID"`.
  - `DBS_78` and `DBS_186` (`nmf_matrix`)
  - `ID_28`, `ID_83`, `ID_415`

```{r calc_dbs_id}
apgi_DBS <- sigminer::sig_tally(
  apgi,
  ref_genome = "BSgenome.Hsapiens.UCSC.hg38",
  useSyn = TRUE,
  mode = "DBS",
  add_trans_bias = TRUE
)
str(apgi_DBS$all_matrices)
stopifnot(identical(apgi_DBS$nmf_matrix, apgi_DBS$all_matrices$DBS_186))

apgi_ID <- sigminer::sig_tally(
  apgi,
  ref_genome = "BSgenome.Hsapiens.UCSC.hg38",
  useSyn = TRUE,
  mode = "ID",
  add_trans_bias = TRUE
)
str(apgi_ID$all_matrices, list.len = 3)
stopifnot(identical(apgi_ID$nmf_matrix, apgi_ID$all_matrices$ID_415))
```

#### SBS, DBS and ID

* Use `mode = "ALL"` to get all three different matrices.

```{r calc_all, eval=F}
apgi_ALL <- sigminer::sig_tally(
  apgi,
  ref_genome = "BSgenome.Hsapiens.UCSC.hg38",
  useSyn = TRUE,
  mode = "ALL",
  add_trans_bias = TRUE
)
```

### Extract Signatures

#### NMF method

* Run NMF multiple times then select best number of signatures based on the
  measure vs. signature number plot.
* Measure `cophenetic` is generally used for determining number of signatures.

```{r sig_num_estimate, eval=F}
est_sig <- sigminer::sig_estimate(
  apgi_SBS$nmf_matrix,
  range = 2:5,
  nrun = 2,
  use_random = TRUE,
  cores = 4,
  pConstant = 1e-13,
  verbose = TRUE)
saveRDS(est_sig, file = here::here("nogit/sigminer/apgi_sigs1_estim.rds"))
```

```{r show_est_sig}
est_sig <- readRDS(file = here::here("nogit/sigminer/apgi_sigs1_estim.rds"))

sigminer::show_sig_number_survey2(est_sig$survey, est_sig$survey.random)
sigminer::show_sig_number_survey(est_sig$survey, right_y = NULL)
```

```{r extract_sigs_nmf, eval=F}
sigs <- sigminer::sig_extract(apgi_SBS$nmf_matrix,
                              n_sig = 3,
                              nrun = 10,
                              cores = 4,
                              pConstant = 1e-13)
saveRDS(sigs, file = here::here("nogit/sigminer/apgi_sigs1.rds"))
```

```{r extract_sigs_nmf_show}
sigs <- readRDS(file = here::here("nogit/sigminer/apgi_sigs1.rds"))
```

#### Bayesian NMF

* This method estimates number of signatures automatically.

```{r extract_sigs_auto, eval=F}
sigs2 <- sigminer::sig_auto_extract(apgi_SBS$nmf_matrix, K0 = 10, nrun = 10)
saveRDS(sigs2, file = here::here("nogit/sigminer/apgi_sigs2.rds"))
```

```{r extract_sigs_auto_show}
sigs2 <- readRDS(file = here::here("nogit/sigminer/apgi_sigs2.rds"))
sigs2$Raw$summary_run
```


### Match Signatures

* Compare these signatures to the COSMIC ones:

```{r sig_similarity}
sim <- sigminer::get_sig_similarity(sigs)
f1 <- function(s) {
  a <- s$aetiology
  m <- sub("Best match: ", "", s$best_match)
  paste0(m, ": ", a)
}

sim_best_match_COSMIC_v2 <- purrr::map(sim$best_match, f1) %>%
  dplyr::bind_rows(.id = "sig") %>%
  tidyr::pivot_longer(cols = Sig1:Sig3, names_to = "Sigs", values_to = "COSMIC")

pheatmap::pheatmap(sim$similarity)

sim_best_match_COSMIC_v3 <- sigminer::get_sig_similarity(sigs, sig_db = "SBS")$best_match %>%
  purrr::map(f1) %>%
  dplyr::bind_rows(.id = "sig") %>%
  tidyr::pivot_longer(cols = Sig1:Sig3, names_to = "Sigs", values_to = "COSMIC")

dplyr::left_join(sim_best_match_COSMIC_v2, sim_best_match_COSMIC_v3, by = "Sigs", suffix = c("_v2", "_v3"))
```

### Sample Signatures

```{r sample_sigs}
knitr::kable(sigminer::get_sig_exposure(sigs))
```


## Group Analysis
